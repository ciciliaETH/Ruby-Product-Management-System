<!-- Page Header -->
<div class="mb-8">
    <div class="flex items-center space-x-3 mb-4">
        <a href="/purchases" class="text-gray-500 hover:text-gray-700">
            <i class="fas fa-arrow-left text-lg"></i>
        </a>
        <h1 class="text-3xl font-bold text-gray-900 flex items-center">
            <i class="fas fa-shopping-bag mr-3 text-primary-600"></i>
            Buat Pembelian Baru
        </h1>
    </div>
    <p class="text-gray-600">Pilih produk dan masukkan jumlah yang ingin dibeli</p>
</div>

<div class="max-w-2xl mx-auto">
    <% if @products.empty? %>
        <div class="bg-white rounded-xl shadow-lg p-8 text-center">
            <i class="fas fa-box-open text-gray-300 text-6xl mb-4"></i>
            <h3 class="text-xl font-semibold text-gray-900 mb-2">Tidak Ada Produk Tersedia</h3>
            <p class="text-gray-600 mb-6">Anda perlu menambahkan produk terlebih dahulu sebelum dapat membuat pembelian</p>
            <a href="/products/new" class="bg-primary-600 text-white px-6 py-3 rounded-lg font-medium hover:bg-primary-700 transition-colors inline-flex items-center space-x-2">
                <i class="fas fa-plus"></i>
                <span>Tambah Produk</span>
            </a>
        </div>
    <% else %>
        <form method="POST" action="/purchases" class="bg-white shadow-xl rounded-xl p-8 border border-gray-100">
            <!-- Product Selection -->
            <div class="mb-6">
                <label for="product_id" class="block text-sm font-medium text-gray-700 mb-3">
                    <i class="fas fa-box mr-2 text-primary-600"></i>
                    Pilih Produk
                </label>
                <select id="product_id" 
                        name="product_id" 
                        required 
                        onchange="updateProductInfo()"
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500 transition-colors">
                    <option value="">-- Pilih Produk --</option>
                    <% @products.each do |product| %>
                        <% if product['stock'] > 0 %>
                            <option value="<%= product['id'] %>" 
                                    data-price="<%= product['price'] %>" 
                                    data-stock="<%= product['stock'] %>"
                                    data-name="<%= product['name'] %>"
                                    data-description="<%= product['description'] %>">
                                <%= product['name'] %> - Stok: <%= product['stock'] %> - Rp <%= number_with_delimiter(product['price'].to_i) %>
                            </option>
                        <% end %>
                    <% end %>
                </select>
            </div>

            <!-- Product Information Display -->
            <div id="product-info" class="hidden mb-6 bg-gray-50 rounded-lg p-4">
                <h4 class="text-sm font-medium text-gray-900 mb-3 flex items-center">
                    <i class="fas fa-info-circle mr-2"></i>
                    Informasi Produk
                </h4>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm">
                    <div>
                        <span class="text-gray-600">Nama:</span>
                        <div id="selected-name" class="font-medium text-gray-900"></div>
                    </div>
                    <div>
                        <span class="text-gray-600">Harga Satuan:</span>
                        <div id="selected-price" class="font-medium text-gray-900"></div>
                    </div>
                    <div>
                        <span class="text-gray-600">Stok Tersedia:</span>
                        <div id="selected-stock" class="font-medium text-gray-900"></div>
                    </div>
                </div>
                <div class="mt-3">
                    <span class="text-gray-600">Deskripsi:</span>
                    <div id="selected-description" class="font-medium text-gray-900 mt-1"></div>
                </div>
            </div>

            <!-- Quantity -->
            <div class="mb-6">
                <label for="quantity" class="block text-sm font-medium text-gray-700 mb-2">
                    <i class="fas fa-hashtag mr-2 text-primary-600"></i>
                    Jumlah
                </label>
                <input type="number" 
                       id="quantity" 
                       name="quantity" 
                       required 
                       min="1"
                       onchange="calculateTotal()"
                       oninput="calculateTotal()"
                       class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500 transition-colors"
                       placeholder="Masukkan jumlah">
                <p class="text-sm text-gray-500 mt-1">
                    <i class="fas fa-exclamation-circle mr-1"></i>
                    Pastikan jumlah tidak melebihi stok yang tersedia
                </p>
            </div>

            <!-- Total Price Display -->
            <div id="total-display" class="hidden mb-8 bg-primary-50 border border-primary-200 rounded-lg p-4">
                <div class="flex justify-between items-center">
                    <span class="text-primary-700 font-medium">Total Harga:</span>
                    <span id="total-price" class="text-2xl font-bold text-primary-600"></span>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="flex space-x-4">
                <button type="submit" 
                        class="flex-1 bg-primary-600 text-white py-3 px-6 rounded-lg font-medium hover:bg-primary-700 transition-colors flex items-center justify-center space-x-2 shadow-lg">
                    <i class="fas fa-shopping-cart"></i>
                    <span>Buat Pembelian</span>
                </button>
                <a href="/purchases" 
                   class="flex-1 bg-gray-100 text-gray-700 py-3 px-6 rounded-lg font-medium hover:bg-gray-200 transition-colors flex items-center justify-center space-x-2 border border-gray-300">
                    <i class="fas fa-times"></i>
                    <span>Batal</span>
                </a>
            </div>
        </form>

        <!-- Available Products -->
        <div class="mt-8 bg-white rounded-xl shadow-lg p-6">
            <h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                <i class="fas fa-list mr-2 text-primary-600"></i>
                Produk Tersedia
            </h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <% @products.select { |p| p['stock'] > 0 }.each do |product| %>
                    <div class="border border-gray-200 rounded-lg p-4 hover:border-primary-300 transition-colors">
                        <div class="flex justify-between items-start mb-2">
                            <h4 class="font-medium text-gray-900"><%= product['name'] %></h4>
                            <span class="text-primary-600 font-bold">Rp <%= number_with_delimiter(product['price'].to_i) %></span>
                        </div>
                        <p class="text-sm text-gray-600 mb-2"><%= product['description'] %></p>
                        <div class="flex justify-between items-center text-sm">
                            <span class="text-gray-500">Stok: <%= product['stock'] %></span>
                            <% if product['stock'] > 10 %>
                                <span class="bg-green-100 text-green-800 px-2 py-1 rounded-full text-xs">Tersedia</span>
                            <% elsif product['stock'] > 0 %>
                                <span class="bg-yellow-100 text-yellow-800 px-2 py-1 rounded-full text-xs">Terbatas</span>
                            <% end %>
                        </div>
                    </div>
                <% end %>
            </div>
        </div>
    <% end %>
</div>

<script>
    function updateProductInfo() {
        const select = document.getElementById('product_id');
        const productInfo = document.getElementById('product-info');
        const selectedOption = select.options[select.selectedIndex];
        
        if (selectedOption.value) {
            const name = selectedOption.getAttribute('data-name');
            const price = selectedOption.getAttribute('data-price');
            const stock = selectedOption.getAttribute('data-stock');
            const description = selectedOption.getAttribute('data-description');
            
            document.getElementById('selected-name').textContent = name;
            document.getElementById('selected-price').textContent = 'Rp ' + parseInt(price).toLocaleString('id-ID');
            document.getElementById('selected-stock').textContent = stock + ' unit';
            document.getElementById('selected-description').textContent = description || 'Tidak ada deskripsi';
            
            productInfo.classList.remove('hidden');
            
            // Update quantity max
            const quantityInput = document.getElementById('quantity');
            quantityInput.max = stock;
            
            calculateTotal();
        } else {
            productInfo.classList.add('hidden');
            document.getElementById('total-display').classList.add('hidden');
        }
    }
    
    function calculateTotal() {
        const select = document.getElementById('product_id');
        const quantityInput = document.getElementById('quantity');
        const totalDisplay = document.getElementById('total-display');
        const totalPrice = document.getElementById('total-price');
        
        const selectedOption = select.options[select.selectedIndex];
        
        if (selectedOption.value && quantityInput.value) {
            const price = parseFloat(selectedOption.getAttribute('data-price'));
            const quantity = parseInt(quantityInput.value);
            const total = price * quantity;
            
            totalPrice.textContent = 'Rp ' + total.toLocaleString('id-ID');
            totalDisplay.classList.remove('hidden');
            
            // Check if quantity exceeds stock
            const stock = parseInt(selectedOption.getAttribute('data-stock'));
            if (quantity > stock) {
                quantityInput.setCustomValidity(`Jumlah tidak boleh melebihi stok (${stock})`);
                quantityInput.classList.add('border-red-500');
            } else {
                quantityInput.setCustomValidity('');
                quantityInput.classList.remove('border-red-500');
            }
        } else {
            totalDisplay.classList.add('hidden');
        }
    }
</script>
